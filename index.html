<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Expense Tracker - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom Font */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Custom cubic-bezier timing function for transitions */
        .ease-custom {
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Sidebar Styling */
        #sidebar {
            transition: transform 0.3s ease-custom;
        }
        #sidebar.translate-x-full {
            transform: translateX(100%); 
        }
        @media (min-width: 768px) { 
            #sidebar.md:-translate-x-full { 
                transform: translateX(-100%);
            }
             #sidebar.md:not(.-translate-x-full) {
                transform: translateX(0);
            }
        }

        /* Active nav link styling */
        .nav-link.active {
            background-color: #f0f9ff; /* sky-50 */
            color: #0369a1; /* sky-700 */
            font-weight: 600;
            border-left: 3px solid #0ea5e9; /* cyan-500 */
            padding-left: calc(0.75rem - 3px) !important;
        }
         .nav-link.active svg {
            color: #0ea5e9; /* cyan-500 */
        }
        
        /* Styling for input fields and select */
        .form-input, .form-select, .form-checkbox, .form-date-input, .form-textarea {
            border-width: 1px;
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.625rem 0.875rem; 
            font-size: 0.875rem; /* text-sm */
            line-height: 1.25rem;
            width: 100%;
            box-sizing: border-box;
            border-color: #e5e7eb; /* gray-200 */
            background-color: white;
            transition: border-color 0.2s ease-custom, box-shadow 0.2s ease-custom;
        }
        .form-textarea { min-height: 80px; }
        .form-input:focus, .form-select:focus, .form-checkbox:focus, .form-date-input:focus, .form-textarea:focus {
             box-shadow: 0 0 0 2px #7dd3fc; /* ring-2 ring-sky-300 */
             border-color: #0ea5e9; /* border-cyan-500 */
             outline: none;
        }
        .form-input.invalid, .form-select.invalid, .form-date-input.invalid, .form-textarea.invalid {
            border-color: #ef4444; /* red-500 */
            box-shadow: 0 0 0 2px #fecaca; /* ring-red-200 */
        }
        .form-input.valid, .form-select.valid, .form-date-input.valid, .form-textarea.valid {
            border-color: #22c55e; /* green-500 */
            box-shadow: 0 0 0 2px #bbf7d0; /* ring-green-200 */
        }

        .form-select {
            appearance: none; 
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem; 
        }
        .form-checkbox {
            width: auto; 
            padding: 0.375rem; 
            margin-right: 0.5rem; 
            border-color: #d1d5db; 
            color: #0ea5e9; /* cyan-500 */
        }
        .form-checkbox:checked {
            background-color: #0ea5e9; /* cyan-500 */
            border-color: #0ea5e9; /* cyan-500 */
        }
         .form-checkbox:focus {
            box-shadow: 0 0 0 2px #67e8f9; /* ring-cyan-300 */
            border-color: #06b6d4; /* border-cyan-600 */
        }
        .flatpickr-input { background-color: white !important; }

        .btn-icon-text { display: inline-flex; align-items: center; justify-content: center; }
        .btn-icon-text svg { margin-right: 0.4rem; }

        .row-deleting { opacity: 0; transform: scale(0.95); transition: opacity 0.3s ease-custom, transform 0.3s ease-custom; }
        .row-adding { animation: fadeInScaleUp 0.4s ease-custom forwards; }
        @keyframes fadeInScaleUp {
            from { opacity: 0; transform: scale(0.95) translateY(-10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        
        #expenseChartContainer, #dashboardChartContainer { height: 300px; }
        @media (min-width: 640px) { 
            #expenseChartContainer, #dashboardChartContainer { height: 350px; }
        }
      
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .status-dot.paid { background-color: #22c55e; } /* green-500 */
        .status-dot.unpaid { background-color: #f97316; } /* orange-500 */

        .status-switch-container { display: flex; align-items: center; min-height: 20px; }
        .status-text-indicator { font-size: 0.8rem; margin-left: 0.625rem; line-height: 1; }
        .status-text-indicator.paid { color: #166534; font-weight: 500; } /* green-800 */
        .status-text-indicator.unpaid { color: #9a3412; } /* orange-800 */

        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(15, 23, 42, 0.6); 
            display: flex; align-items: center; justify-content: center;
            z-index: 50; opacity: 0; visibility: hidden;
            transition: opacity 0.25s ease-custom, visibility 0s 0.25s ease-custom; 
        }
        .modal-overlay.active {
            opacity: 1; visibility: visible;
            transition: opacity 0.25s ease-custom, visibility 0s 0s ease-custom;
        }
        .modal-content {
            background-color: white; padding: 1.75rem 2.25rem; 
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.07), 0 4px 6px -4px rgba(0,0,0,0.05); 
            width: 90%; max-width: 500px;
            transform: scale(0.93); opacity: 0;
            transition: transform 0.25s ease-custom, opacity 0.25s ease-custom;
        }
        .modal-overlay.active .modal-content { transform: scale(1); opacity: 1; }

        .notification-toast {
            position: fixed; bottom: 20px; right: 20px;
            background-color: #1e293b; /* slate-800 */
            color: white; padding: 1rem 1.5rem; border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); /* shadow-md */
            z-index: 100; opacity: 0; transform: translateY(25px); 
            transition: opacity 0.35s ease-custom, transform 0.35s ease-custom; 
            font-size: 0.875rem;
        }
        .notification-toast.show { opacity: 1; transform: translateY(0); }
        .notification-toast.error { background-color: #dc2626; } /* red-600 */
        .notification-toast.success { background-color: #16a34a; } /* green-600 */
        
        .validation-message { font-size: 0.75rem; color: #ef4444; margin-top: 0.25rem; display: block; min-height: 1.2em; }

        /* Table Mobile Card View */
        @media (max-width: 767px) { 
            #expense-table-body tr.data-row, #recent-expenses-table-body tr.data-row, #income-table-body tr.data-row {
                display: block;
                margin-bottom: 1rem;
                border-radius: 0.5rem; /* rounded-lg */
                box-shadow: 0 1px 3px 0 rgba(0,0,0,0.07), 0 1px 2px -1px rgba(0,0,0,0.07); 
                overflow: hidden;
                border: 1px solid #e5e7eb; /* gray-200 */
            }
            #expense-table-body tr.data-row td, #recent-expenses-table-body tr.data-row td, #income-table-body tr.data-row td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 1rem 1rem; 
                text-align: right;
                border-bottom: 1px solid #f3f4f6; /* gray-100 */
            }
             #expense-table-body tr.data-row td:last-child, #recent-expenses-table-body tr.data-row td:last-child, #income-table-body tr.data-row td:last-child {
                border-bottom: none;
            }
            #expense-table-body tr.data-row td::before, #recent-expenses-table-body tr.data-row td::before, #income-table-body tr.data-row td::before {
                content: attr(data-label);
                font-weight: 600; /* semibold */
                text-align: left;
                margin-right: 0.5rem;
                color: #4b5563; /* gray-600 */
            }
            #expense-table-head, #recent-expenses-table-head, #income-table-head { display: none; } 
        }
        /* Zebra striping for table (very subtle) */
        #expense-table-body tr.data-row:nth-child(even):not([style*="display: none;"]),
        #income-table-body tr.data-row:nth-child(even):not([style*="display: none;"]) {
             background-color: #f8fafc; /* slate-50 */
        }
        #expense-table-body tr.data-row:nth-child(odd):not([style*="display: none;"]),
        #income-table-body tr.data-row:nth-child(odd):not([style*="display: none;"]) {
             background-color: white;
        }
        @media (min-width: 768px) {
            #expense-table-body tr.data-row, #income-table-body tr.data-row {
                margin-bottom: 0;
                border-radius: 0;
                box-shadow: none;
                border: none;
                border-bottom: 1px solid #e5e7eb;
            }
             #expense-table-body tr.data-row td, #income-table-body tr.data-row td {
                display: table-cell;
                text-align: left;
             }
             #expense-table-body tr.data-row td::before, #income-table-body tr.data-row td::before {
                display: none;
             }
        }

        .empty-state-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem 1rem;
            text-align: center;
            background-color: white;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05); /* shadow-sm */
            border: 1px dashed #cbd5e1; /* slate-300 */
        }
        .empty-state-container svg {
            width: 3.5rem; height: 3.5rem;
            color: #94a3b8; /* slate-400 */
            margin-bottom: 1rem;
        }
        .empty-state-container p {
            font-size: 1rem; color: #475569; /* slate-600 */
            margin-bottom: 0.5rem;
        }
        .empty-state-container span {
            font-size: 0.875rem; color: #64748b; /* slate-500 */
        }
        /* Settings Page Specific Styles */
        .settings-section {
            background-color: white;
            padding: 1.5rem; /* p-6 */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.07), 0 1px 2px -1px rgba(0,0,0,0.07); /* Softer shadow */
            margin-bottom: 2rem; /* mb-8 */
        }
        .settings-section h2 {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600; /* font-semibold */
            color: #334155; /* slate-700 */
            margin-bottom: 1.5rem; /* mb-6 */
            border-bottom: 1px solid #e5e7eb; /* border-slate-200 */
            padding-bottom: 0.75rem; /* pb-3 */
        }
        .list-item-management {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f3f4f6; /* gray-100 */
        }
        .list-item-management:last-child {
            border-bottom: none;
        }
        .list-item-management span {
            font-size: 0.875rem; /* text-sm */
            color: #475569; /* slate-600 */
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div class="flex h-screen overflow-hidden">
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-64 bg-white shadow-lg p-6 space-y-4 transform md:translate-x-0 -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out border-r border-slate-200">
            <div class="text-center mb-2">
                <h2 class="text-2xl font-semibold text-cyan-600">XPenseTrack</h2>
            </div>

            <button id="show-add-expense-modal-btn" class="w-full btn-icon-text border border-cyan-500 text-cyan-500 hover:bg-cyan-50 hover:text-cyan-600 font-medium py-2.5 px-4 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-cyan-400 focus:ring-offset-1 transition-all duration-200 ease-custom">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                Add Expense
            </button>
            <button id="show-add-income-modal-btn" class="w-full btn-icon-text border border-green-500 text-green-500 hover:bg-green-50 hover:text-green-600 font-medium py-2.5 px-4 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-offset-1 transition-all duration-200 ease-custom mt-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg> Add Income
            </button>

            <nav class="space-y-1.5 pt-2">
                <a href="#" id="nav-dashboard" class="nav-link group flex items-center px-3 py-2.5 text-sm font-medium rounded-md text-slate-700 hover:bg-slate-100 hover:text-slate-900">
                    <svg class="mr-3 h-5 w-5 text-slate-400 group-hover:text-slate-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h7.5" /></svg>
                    Dashboard
                </a>
                <a href="#" id="nav-all-expenses" class="nav-link group flex items-center px-3 py-2.5 text-sm font-medium rounded-md text-slate-700 hover:bg-slate-100 hover:text-slate-900">
                    <svg class="mr-3 h-5 w-5 text-slate-400 group-hover:text-slate-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 0 1 0 3.75H5.625a1.875 1.875 0 0 1 0-3.75Z" /></svg>
                    All Expenses
                </a>
                <a href="#" id="nav-income" class="nav-link group flex items-center px-3 py-2.5 text-sm font-medium rounded-md text-slate-700 hover:bg-slate-100 hover:text-slate-900">
                    <svg class="mr-3 h-5 w-5 text-slate-400 group-hover:text-slate-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0 1 15.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 0 1 3 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 0 0-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 0 1-1.125-1.125V15m1.5 1.5v-.75A.75.75 0 0 0 3 15h-.75M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Zm3 0h.008v.008H18V10.5Zm-12 0h.008v.008H6V10.5Z" /></svg>
                    Income
                </a>
                <a href="#" id="nav-settings" class="nav-link group flex items-center px-3 py-2.5 text-sm font-medium rounded-md text-slate-700 hover:bg-slate-100 hover:text-slate-900">
                     <svg class="mr-3 h-5 w-5 text-slate-400 group-hover:text-slate-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.343 3.94c.09-.542.56-.94 1.11-.94h1.093c.55 0 1.02.398 1.11.94l.149.894c.07.424.384.764.78.93.398.164.855.142 1.205-.108l.737-.527a1.125 1.125 0 0 1 1.45.12l.773.774c.39.389.44 1.002.12 1.45l-.527.737c-.25.35-.272.806-.108 1.204.165.397.505.71.93.78l.893.15c.543.09.94.56.94 1.11v1.093c0 .55-.397 1.02-.94 1.11l-.893.149c-.425.07-.765.383-.93.78-.165.398-.142.854.107 1.204l.527.738c.32.447.269 1.06-.12 1.45l-.774.773a1.125 1.125 0 0 1-1.449.12l-.738-.527c-.35-.25-.806-.272-1.203-.107-.397.165-.71.505-.78.93l-.15.894c-.09.542-.56.94-1.11.94h-1.094c-.55 0-1.019-.398-1.11-.94l-.149-.894c-.07-.424-.384-.764-.78-.93-.398-.164-.854-.142-1.204.108l-.738.527c-.447.32-1.06.269-1.45-.12l-.773-.774a1.125 1.125 0 0 1-.12-1.45l.527-.737c.25-.35.272-.806.108-1.204-.165-.397-.505-.71-.93-.78l-.894-.15c-.542-.09-.94-.56-.94-1.11v-1.094c0-.55.398-1.019.94-1.11l.894-.149c.424-.07.764-.383.93-.78.165-.398.142-.854-.107-1.204l-.527-.738a1.125 1.125 0 0 1 .12-1.45l.773-.773a1.125 1.125 0 0 1 1.45-.12l.737.527c.35.25.807.272 1.204.107.397-.165.71-.505.78-.93l.149-.893Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg>
                    Settings
                </a>
            </nav>

            <div class="space-y-4 pt-4 border-t border-slate-200">
                <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Filters</h3>
                <div>
                    <label for="filter-date-range" class="block text-xs font-medium text-slate-600 mb-1">Date Range</label>
                    <select id="filter-date-range" class="form-select text-sm w-full">
                        <option value="all">All Time</option>
                        <option value="this-month">This Month</option>
                        <option value="last-month">Last Month</option>
                        <option value="this-year">This Year</option>
                    </select>
                </div>
                <div>
                    <label for="filter-status" class="block text-xs font-medium text-slate-600 mb-1">Status (Expenses)</label>
                    <select id="filter-status" class="form-select text-sm w-full">
                        <option value="all">All Statuses</option>
                        <option value="paid">Paid</option>
                        <option value="unpaid">Unpaid</option>
                    </select>
                </div>
                 <div>
                    <label for="filter-category-sidebar" class="block text-xs font-medium text-slate-600 mb-1">Category (Expenses)</label>
                    <select id="filter-category-sidebar" class="form-select text-sm w-full">
                        <option value="all">All Categories</option>
                        </select>
                </div>
            </div>
            
            <div id="sidebar-totals-card" class="space-y-3 pt-4 border-t border-slate-200">
                <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">Summary (Filtered)</h3>
                <div class="flex justify-between items-center">
                    <span class="text-sm font-medium text-slate-500">Total Income:</span>
                    <span id="sidebar-total-income" class="text-sm font-semibold text-emerald-600">0.00 DH</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm font-medium text-slate-500">Expenses Paid:</span>
                    <span id="sidebar-total-paid" class="text-sm font-semibold text-green-600">0.00 DH</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm font-medium text-slate-500">Expenses Unpaid:</span>
                    <span id="sidebar-total-unpaid" class="text-sm font-semibold text-orange-600">0.00 DH</span>
                </div>
                <hr class="my-2 border-slate-200">
                <div class="flex justify-between items-center">
                    <span class="text-md font-semibold text-slate-600">Net (Income - All Exp.):</span>
                    <span id="sidebar-grand-total" class="text-md font-bold text-slate-800">0.00 DH</span>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col overflow-y-auto overflow-x-hidden">
             <header class="md:hidden sticky top-0 bg-white shadow-sm z-30 p-4 flex justify-between items-center border-b border-slate-200">
                <h1 id="mobile-header-title" class="text-xl font-semibold text-cyan-600">Dashboard</h1>
                <button id="sidebar-toggle-mobile" class="text-slate-500 hover:text-cyan-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
            </header>
            
            <div class="p-4 sm:p-6 lg:p-8 flex-1">
                <div id="dashboard-view">
                    <h1 class="text-2xl sm:text-3xl font-semibold text-slate-700 mb-6 hidden md:block">Dashboard</h1>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white shadow-md rounded-xl p-6">
                            <h3 class="text-sm font-medium text-slate-500 mb-1">Total Income (This Month)</h3>
                            <p id="dashboard-total-income-month" class="text-3xl font-bold text-emerald-500">0.00 DH</p>
                        </div>
                        <div class="bg-white shadow-md rounded-xl p-6">
                            <h3 class="text-sm font-medium text-slate-500 mb-1">Total Spent (This Month)</h3>
                            <p id="dashboard-total-spent-month" class="text-3xl font-bold text-cyan-600">0.00 DH</p>
                        </div>
                        <div class="bg-white shadow-md rounded-xl p-6">
                            <h3 class="text-sm font-medium text-slate-500 mb-1">Net Savings (This Month)</h3>
                            <p id="dashboard-net-savings-month" class="text-3xl font-bold text-blue-600">0.00 DH</p>
                        </div>
                        <div class="bg-white shadow-md rounded-xl p-6">
                            <h3 class="text-sm font-medium text-slate-500 mb-1">Unpaid Expenses (Month)</h3>
                            <p id="dashboard-total-unpaid-month" class="text-3xl font-bold text-orange-500">0.00 DH</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white shadow-lg rounded-xl p-4 sm:p-6">
                            <h2 class="text-lg font-semibold text-slate-700 mb-4">Expense Distribution (This Month)</h2>
                            <div id="dashboardChartContainer">
                                <canvas id="dashboardExpenseChart"></canvas>
                            </div>
                            <div id="no-dashboard-chart-data-message" class="empty-state-container" style="display: none;">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M7.5 14.25v2.25m3-4.5v4.5m3-6.75v6.75m3-9v9M6 20.25h12A2.25 2.25 0 0 0 20.25 18V6A2.25 2.25 0 0 0 18 3.75H6A2.25 2.25 0 0 0 3.75 6v12A2.25 2.25 0 0 0 6 20.25Z" /></svg>
                                <p>No chart data available.</p>
                                <span>Add some expenses for the current month.</span>
                            </div>
                        </div>

                        <div class="bg-white shadow-lg rounded-xl p-4 sm:p-6">
                            <h2 class="text-lg font-semibold text-slate-700 mb-4">Recent Transactions (Expenses)</h2>
                            <div class="overflow-x-auto">
                                <table class="min-w-full">
                                    <thead id="recent-expenses-table-head" class="bg-slate-50 border-b border-slate-200">
                                        <tr>
                                            <th class="py-4 px-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Date</th>
                                            <th class="py-4 px-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Expense</th>
                                            <th class="py-4 px-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Amount</th>
                                            <th class="py-4 px-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recent-expenses-table-body" class="text-slate-700"></tbody>
                                </table>
                            </div>
                            <div id="no-recent-expenses-message" class="empty-state-container mt-4" style="display: none;">
                                 <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 6.75h7.5M8.25 12h7.5m-7.5 5.25h7.5m3-15H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V4.875c0-.621-.504-1.125-1.125-1.125Z" /></svg>
                                <p>No recent expenses.</p>
                                <span>Add an expense to see it here.</span>
                            </div>
                        </div>
                    </div>
                     <div class="mt-6 bg-white shadow-lg rounded-xl p-4 sm:p-6">
                        <h2 class="text-lg font-semibold text-slate-700 mb-4">Upcoming Recurring Expenses (Placeholder)</h2>
                        <div class="empty-state-container">
                             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5m-9-3.75h.008v.008H12v-.008ZM12 15h.008v.008H12V15Zm0 2.25h.008v.008H12v-.008ZM9.75 15h.008v.008H9.75V15Zm0 2.25h.008v.008H9.75v-.008ZM7.5 15h.008v.008H7.5V15Zm0 2.25h.008v.008H7.5v-.008Zm6.75-4.5h.008v.008h-.008v-.008Zm0 2.25h.008v.008h-.008V15Zm0 2.25h.008v.008h-.008v-.008Zm2.25-4.5h.008v.008H16.5v-.008Zm0 2.25h.008v.008H16.5V15Z" /></svg>
                            <p>Recurring expenses feature coming soon!</p>
                            <span>This section will show your scheduled payments.</span>
                        </div>
                    </div>
                </div>

                <div id="all-expenses-view" style="display: none;">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
                        <h1 class="text-2xl sm:text-3xl font-semibold text-slate-700 mb-4 sm:mb-0 hidden md:block">All Expenses</h1>
                        <button id="sort-date-btn" class="btn-icon-text border border-slate-300 hover:border-slate-400 bg-white hover:bg-slate-50 text-slate-600 font-medium py-2 px-3 rounded-md text-xs shadow-sm hover:shadow focus:outline-none focus:ring-2 focus:ring-slate-300 focus:ring-offset-1 transition-all duration-150 ease-custom">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 sort-icon-desc"><path stroke-linecap="round" stroke-linejoin="round" d="M3 4.5h14.25M3 9h9.75M3 13.5h5.25m5.25-.75L17.25 9m0 0L21 12.75M17.25 9v12" /></svg>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 sort-icon-asc hidden"><path stroke-linecap="round" stroke-linejoin="round" d="M3 4.5h14.25M3 9h9.75M3 13.5h5.25m5.25 4.5L17.25 21m0 0L21 17.25M17.25 21V9" /></svg>
                            Sort Date
                        </button>
                    </div>
                    <div class="bg-white shadow-lg rounded-xl overflow-hidden">
                        <table class="min-w-full">
                            <thead id="expense-table-head" class="bg-slate-50 border-b border-slate-200">
                                <tr>
                                    <th class="py-4 px-4 sm:px-6 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider w-32">Date</th>
                                    <th class="py-4 px-4 sm:px-6 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Expense</th>
                                    <th class="py-4 px-4 sm:px-6 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Category</th>
                                    <th class="py-4 px-4 sm:px-6 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Method</th>
                                    <th class="py-4 px-4 sm:px-6 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Amount</th>
                                    <th class="py-4 px-4 sm:px-6 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider w-36">Status</th>
                                    <th class="py-4 px-4 sm:px-6 text-center text-xs font-semibold text-slate-500 uppercase tracking-wider w-32">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="text-slate-700" id="expense-table-body"></tbody>
                        </table>
                    </div>
                    <div id="no-expenses-message" class="mt-6 empty-state-container" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" /></svg>
                        <p>No expenses found.</p>
                        <span>Try adjusting your filters or add a new expense.</span>
                    </div>

                    <div class="mt-12 bg-white shadow-lg rounded-xl p-4 sm:p-6">
                        <h2 class="text-xl font-semibold text-slate-700 mb-6 text-center">Expense Distribution (Filtered)</h2>
                        <div id="expenseChartContainer">
                             <canvas id="expenseChart"></canvas>
                        </div>
                        <div id="no-chart-data-message" class="empty-state-container" style="display: none;">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M7.5 14.25v2.25m3-4.5v4.5m3-6.75v6.75m3-9v9M6 20.25h12A2.25 2.25 0 0 0 20.25 18V6A2.25 2.25 0 0 0 18 3.75H6A2.25 2.25 0 0 0 3.75 6v12A2.25 2.25 0 0 0 6 20.25Z" /></svg>
                            <p>Not enough data for chart.</p>
                            <span>Apply different filters or add more expenses.</span>
                        </div>
                    </div>
                </div>

                <div id="income-view" style="display: none;">
                    <h1 class="text-2xl sm:text-3xl font-semibold text-slate-700 mb-6 hidden md:block">Income</h1>
                    <div class="bg-white shadow-lg rounded-xl overflow-hidden">
                        <table class="min-w-full">
                            <thead id="income-table-head" class="bg-slate-50 border-b border-slate-200">
                                <tr>
                                    <th class="py-4 px-4 sm:px-6 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider w-32">Date</th>
                                    <th class="py-4 px-4 sm:px-6 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Source</th>
                                    <th class="py-4 px-4 sm:px-6 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Amount</th>
                                    <th class="py-4 px-4 sm:px-6 text-center text-xs font-semibold text-slate-500 uppercase tracking-wider w-32">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="text-slate-700" id="income-table-body"></tbody>
                        </table>
                    </div>
                    <div id="no-income-message" class="mt-6 empty-state-container" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-14 h-14 text-slate-400 mb-4"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 11.21 12.75 10.5 12 10.5s-1.536.71-2.121 1.359c-1.171.879-1.171 2.303 0 3.182Z" /></svg>
                        <p>No income recorded yet.</p>
                        <span>Click "Add Income" in the sidebar to get started.</span>
                    </div>
                </div>

                <div id="settings-view" style="display: none;">
                    <h1 class="text-2xl sm:text-3xl font-semibold text-slate-700 mb-6 hidden md:block">Settings</h1>
                
                    <section class="settings-section">
                        <h2>Manage Categories</h2>
                        <form id="add-category-form" class="flex gap-x-3 mb-4">
                            <input type="text" id="new-category-name" class="form-input flex-grow" placeholder="New category name" required>
                            <button type="submit" class="btn-icon-text bg-cyan-500 hover:bg-cyan-600 text-white font-medium py-2 px-4 rounded-md text-sm shadow-sm">Add Category</button>
                        </form>
                        <div id="categories-list" class="space-y-2">
                            </div>
                        <div id="no-custom-categories-message" class="mt-4 text-sm text-slate-500" style="display: none;">
                            No custom categories added yet. Default categories are in use.
                        </div>
                    </section>
                
                    <section class="settings-section">
                        <h2>Manage Payment Methods</h2>
                        <form id="add-payment-method-form" class="flex gap-x-3 mb-4">
                            <input type="text" id="new-payment-method-name" class="form-input flex-grow" placeholder="New payment method name" required>
                            <button type="submit" class="btn-icon-text bg-cyan-500 hover:bg-cyan-600 text-white font-medium py-2 px-4 rounded-md text-sm shadow-sm">Add Method</button>
                        </form>
                        <div id="payment-methods-list" class="space-y-2">
                            </div>
                         <div id="no-custom-payment-methods-message" class="mt-4 text-sm text-slate-500" style="display: none;">
                            No custom payment methods added yet. Default methods are in use.
                        </div>
                    </section>
                </div>

            </div>
        </main>
    </div>

    <div id="expense-modal" class="modal-overlay" aria-labelledby="expense-modal-title" role="dialog" aria-modal="true">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="expense-modal-title" class="text-lg font-semibold text-slate-700">Add New Expense</h3>
                <button id="close-expense-modal-btn" class="text-slate-400 hover:text-slate-600">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <form id="expense-form" class="space-y-4">
                <input type="hidden" id="expense-id-field">
                <div>
                    <label for="modal-date-field" class="block text-xs font-medium text-slate-600 mb-1">Date</label>
                    <input type="text" id="modal-date-field" class="form-date-input form-input" placeholder="Select Date" aria-describedby="modal-date-validation">
                    <span id="modal-date-validation" class="validation-message"></span>
                </div>
                <div>
                    <label for="modal-expense-field" class="block text-xs font-medium text-slate-600 mb-1">Expense Description</label>
                    <input type="text" id="modal-expense-field" class="form-input" placeholder="e.g., Coffee" aria-describedby="modal-expense-validation">
                    <span id="modal-expense-validation" class="validation-message"></span>
                </div>
                <div>
                    <label for="modal-category-field" class="block text-xs font-medium text-slate-600 mb-1">Category</label>
                    <select id="modal-category-field" class="form-select" aria-describedby="modal-category-validation"></select>
                    <span id="modal-category-validation" class="validation-message"></span>
                </div>
                 <div>
                    <label for="modal-method-field" class="block text-xs font-medium text-slate-600 mb-1">Payment Method</label>
                    <select id="modal-method-field" class="form-select" aria-describedby="modal-method-validation"></select>
                    <span id="modal-method-validation" class="validation-message"></span>
                </div>
                <div>
                    <label for="modal-amount-field" class="block text-xs font-medium text-slate-600 mb-1">Amount</label>
                    <input type="text" id="modal-amount-field" class="form-input" placeholder="e.g., 50.00 DH" aria-describedby="modal-amount-validation">
                    <span id="modal-amount-validation" class="validation-message"></span>
                </div>
                <div>
                    <label for="modal-tags-field" class="block text-xs font-medium text-slate-600 mb-1">Tags (comma-separated)</label>
                    <input type="text" id="modal-tags-field" class="form-input" placeholder="e.g., work, projectX">
                </div>
                <div>
                    <label for="modal-notes-field" class="block text-xs font-medium text-slate-600 mb-1">Notes</label>
                    <textarea id="modal-notes-field" class="form-textarea" placeholder="Any additional details..."></textarea>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="modal-paid-field" class="form-checkbox h-4 w-4 text-cyan-600 focus:ring-cyan-500 border-slate-300 rounded">
                    <label for="modal-paid-field" class="ml-2 text-sm text-slate-600">Mark as Paid</label>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="cancel-expense-modal-btn" class="btn-icon-text bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium py-2 px-4 rounded-md text-sm border border-slate-300 shadow-sm hover:shadow focus:outline-none focus:ring-2 focus:ring-slate-300 focus:ring-offset-1 transition-all duration-150 ease-custom">Cancel</button>
                    <button type="submit" id="confirm-expense-modal-btn" class="btn-icon-text bg-cyan-500 hover:bg-cyan-600 text-white font-medium py-2 px-4 rounded-md text-sm shadow-sm hover:shadow focus:outline-none focus:ring-2 focus:ring-cyan-400 focus:ring-offset-1 transition-all duration-150 ease-custom">Add Expense</button>
                </div>
            </form>
        </div>
    </div>

    <div id="income-modal" class="modal-overlay" aria-labelledby="income-modal-title" role="dialog" aria-modal="true">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="income-modal-title" class="text-lg font-semibold text-slate-700">Add New Income</h3>
                <button id="close-income-modal-btn" class="text-slate-400 hover:text-slate-600">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <form id="income-form" class="space-y-4">
                <input type="hidden" id="income-id-field">
                <div>
                    <label for="modal-income-date-field" class="block text-xs font-medium text-slate-600 mb-1">Date</label>
                    <input type="text" id="modal-income-date-field" class="form-date-input form-input" placeholder="Select Date" aria-describedby="modal-income-date-validation">
                    <span id="modal-income-date-validation" class="validation-message"></span>
                </div>
                <div>
                    <label for="modal-income-source-field" class="block text-xs font-medium text-slate-600 mb-1">Source</label>
                    <input type="text" id="modal-income-source-field" class="form-input" placeholder="e.g., Salary, Freelance Project" aria-describedby="modal-income-source-validation">
                    <span id="modal-income-source-validation" class="validation-message"></span>
                </div>
                <div>
                    <label for="modal-income-amount-field" class="block text-xs font-medium text-slate-600 mb-1">Amount</label>
                    <input type="text" id="modal-income-amount-field" class="form-input" placeholder="e.g., 1000.00 DH" aria-describedby="modal-income-amount-validation">
                    <span id="modal-income-amount-validation" class="validation-message"></span>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="cancel-income-modal-btn" class="btn-icon-text bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium py-2 px-4 rounded-md text-sm border border-slate-300 shadow-sm hover:shadow focus:outline-none focus:ring-2 focus:ring-slate-300 focus:ring-offset-1 transition-all duration-150 ease-custom">Cancel</button>
                    <button type="submit" id="confirm-income-modal-btn" class="btn-icon-text bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-md text-sm shadow-sm hover:shadow focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-offset-1 transition-all duration-150 ease-custom">Add Income</button>
                </div>
            </form>
        </div>
    </div>

    <div id="delete-confirm-modal" class="modal-overlay" aria-labelledby="delete-modal-title" role="dialog" aria-modal="true">
        <div class="modal-content max-w-md"> 
            <h3 id="delete-modal-title" class="text-lg font-semibold text-slate-700 mb-3">Confirm Deletion</h3>
            <p id="delete-modal-message" class="text-sm text-slate-600 mb-6">Are you sure you want to delete this item? This action cannot be undone.</p>
            <div class="flex justify-end space-x-3">
                <button id="cancel-delete-btn" class="py-2 px-4 rounded-md text-sm font-medium bg-slate-100 hover:bg-slate-200 text-slate-700 border border-slate-300 focus:outline-none focus:ring-2 focus:ring-slate-300 focus:ring-offset-1 transition-all duration-150 ease-custom">Cancel</button>
                <button id="confirm-delete-btn" class="py-2 px-4 rounded-md text-sm font-medium bg-red-600 hover:bg-red-700 text-white focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-1 transition-all duration-150 ease-custom">Confirm Delete</button>
            </div>
        </div>
    </div>

    <div id="notification-toast" class="notification-toast" role="alert" aria-live="assertive"></div>

    <script>
        // --- Global Variables & Constants ---
        const DEFAULT_CATEGORIES = ["Housing", "Food", "Transport", "Utilities", "Entertainment", "Healthcare", "Shopping", "Education", "Other"];
        const DEFAULT_PAYMENT_METHODS = ["Bank Transfer", "Cash", "Credit Card", "Other"];
        const LOCAL_STORAGE_KEY = 'expensesAppData_v8_features'; // Updated key

        let expenses = []; 
        let incomes = [];
        let userCategories = [];
        let userPaymentMethods = [];

        let expenseChartInstance = null; 
        let dashboardChartInstance = null;
        
        let itemToDelete = { id: null, type: null }; // type can be 'expense', 'income', 'category', 'paymentMethod'
        
        let currentSortOrder = 'desc'; 
        let currentView = 'dashboard'; 
        let currentEditingId = null; 
        let currentEditingType = null; // 'expense' or 'income' for modals

        // DOM Elements
        const sidebar = document.getElementById('sidebar');
        const sidebarToggleMobile = document.getElementById('sidebar-toggle-mobile');
        const mobileHeaderTitle = document.getElementById('mobile-header-title');
        
        const navDashboard = document.getElementById('nav-dashboard');
        const navAllExpenses = document.getElementById('nav-all-expenses');
        const navIncome = document.getElementById('nav-income');
        const navSettings = document.getElementById('nav-settings');

        const dashboardView = document.getElementById('dashboard-view');
        const allExpensesView = document.getElementById('all-expenses-view');
        const incomeView = document.getElementById('income-view');
        const settingsView = document.getElementById('settings-view');

        const expenseTableBody = document.getElementById('expense-table-body');
        const recentExpensesTableBody = document.getElementById('recent-expenses-table-body');
        const incomeTableBody = document.getElementById('income-table-body');
        
        const showAddExpenseModalBtn = document.getElementById('show-add-expense-modal-btn');
        const expenseModal = document.getElementById('expense-modal');
        const expenseModalTitle = document.getElementById('expense-modal-title');
        const closeExpenseModalBtn = document.getElementById('close-expense-modal-btn');
        const cancelExpenseModalBtn = document.getElementById('cancel-expense-modal-btn');
        const expenseForm = document.getElementById('expense-form');
        const confirmExpenseModalBtn = document.getElementById('confirm-expense-modal-btn');
        const expenseIdField = document.getElementById('expense-id-field');

        const showAddIncomeModalBtn = document.getElementById('show-add-income-modal-btn');
        const incomeModal = document.getElementById('income-modal');
        const incomeModalTitle = document.getElementById('income-modal-title');
        const closeIncomeModalBtn = document.getElementById('close-income-modal-btn');
        const cancelIncomeModalBtn = document.getElementById('cancel-income-modal-btn');
        const incomeForm = document.getElementById('income-form');
        const confirmIncomeModalBtn = document.getElementById('confirm-income-modal-btn');
        const incomeIdField = document.getElementById('income-id-field');

        const noExpensesMessage = document.getElementById('no-expenses-message');
        const noRecentExpensesMessage = document.getElementById('no-recent-expenses-message');
        const noIncomeMessage = document.getElementById('no-income-message');
        
        // Sidebar Totals
        const sidebarTotalIncomeEl = document.getElementById('sidebar-total-income');
        const sidebarTotalPaidEl = document.getElementById('sidebar-total-paid');
        const sidebarTotalUnpaidEl = document.getElementById('sidebar-total-unpaid');
        const sidebarGrandTotalEl = document.getElementById('sidebar-grand-total');

        // Dashboard Summary
        const dashboardTotalIncomeMonthEl = document.getElementById('dashboard-total-income-month');
        const dashboardTotalSpentMonthEl = document.getElementById('dashboard-total-spent-month');
        const dashboardNetSavingsMonthEl = document.getElementById('dashboard-net-savings-month');
        const dashboardTotalUnpaidMonthEl = document.getElementById('dashboard-total-unpaid-month');


        const expenseChartEl = document.getElementById('expenseChart');
        const dashboardExpenseChartEl = document.getElementById('dashboardExpenseChart');
        const noChartDataMessage = document.getElementById('no-chart-data-message');
        const noDashboardChartDataMessage = document.getElementById('no-dashboard-chart-data-message');
        
        // Expense Modal Form Fields
        const modalDateField = document.getElementById('modal-date-field');
        const modalExpenseField = document.getElementById('modal-expense-field');
        const modalCategoryField = document.getElementById('modal-category-field');
        const modalMethodField = document.getElementById('modal-method-field');
        const modalAmountField = document.getElementById('modal-amount-field');
        const modalTagsField = document.getElementById('modal-tags-field');
        const modalNotesField = document.getElementById('modal-notes-field');
        const modalPaidField = document.getElementById('modal-paid-field');

        // Expense Modal Validation Messages
        const modalDateValidationMsg = document.getElementById('modal-date-validation');
        const modalExpenseValidationMsg = document.getElementById('modal-expense-validation');
        const modalCategoryValidationMsg = document.getElementById('modal-category-validation');
        const modalMethodValidationMsg = document.getElementById('modal-method-validation');
        const modalAmountValidationMsg = document.getElementById('modal-amount-validation');

        // Income Modal Form Fields
        const modalIncomeDateField = document.getElementById('modal-income-date-field');
        const modalIncomeSourceField = document.getElementById('modal-income-source-field');
        const modalIncomeAmountField = document.getElementById('modal-income-amount-field');
        // Income Modal Validation Messages
        const modalIncomeDateValidationMsg = document.getElementById('modal-income-date-validation');
        const modalIncomeSourceValidationMsg = document.getElementById('modal-income-source-validation');
        const modalIncomeAmountValidationMsg = document.getElementById('modal-income-amount-validation');


        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const deleteModalTitle = document.getElementById('delete-modal-title');
        const deleteModalMessage = document.getElementById('delete-modal-message');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

        const notificationToast = document.getElementById('notification-toast');
        let notificationTimeout;

        // Filters
        const filterDateRangeSelect = document.getElementById('filter-date-range');
        const filterStatusSelect = document.getElementById('filter-status');
        const filterCategorySidebarSelect = document.getElementById('filter-category-sidebar');
        const sortDateBtn = document.getElementById('sort-date-btn');
        const sortIconDesc = sortDateBtn.querySelector('.sort-icon-desc');
        const sortIconAsc = sortDateBtn.querySelector('.sort-icon-asc');

        // Settings Page Elements
        const addCategoryForm = document.getElementById('add-category-form');
        const newCategoryNameInput = document.getElementById('new-category-name');
        const categoriesListContainer = document.getElementById('categories-list');
        const noCustomCategoriesMessage = document.getElementById('no-custom-categories-message');

        const addPaymentMethodForm = document.getElementById('add-payment-method-form');
        const newPaymentMethodNameInput = document.getElementById('new-payment-method-name');
        const paymentMethodsListContainer = document.getElementById('payment-methods-list');
        const noCustomPaymentMethodsMessage = document.getElementById('no-custom-payment-methods-message');


        let nextExpenseId = 1;
        let nextIncomeId = 1;

        const icons = { 
            edit: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" /></svg>`,
            delete: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12.56 0c1.153 0 2.24.032 3.287.094M5.116 5.79m10.328_0a60.101 60.101 0 0 1-5.162 0m5.162 0a48.108 48.108 0 0 1 3.478-.397m-1.8_0c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12.56 0c1.153 0 2.24.032 3.287.094M5.116 5.79m10.328 0a60.101 60.101 0 0 1-5.162 0m5.162 0a48.108 48.108 0 0 1 3.478-.397" /></svg>`,
        };
        
        // --- Utility Functions ---
        function parseAmount(amountStr) {
            if (typeof amountStr !== 'string') amountStr = String(amountStr);
            return parseFloat(amountStr.replace(/[^0-9.]/g, "")) || 0;
        }

        function formatCurrency(amount) {
            return `${amount.toFixed(2)} DH`;
        }
        
        function formatDateForStorage(date) {
            if (!date) return null;
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDateForDisplay(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            const userTimezoneOffset = date.getTimezoneOffset() * 60000;
            const localDate = new Date(date.getTime() + userTimezoneOffset); 
            return localDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: '2-digit' });
        }

        function getEffectiveCategories() {
            return userCategories.length > 0 ? userCategories : DEFAULT_CATEGORIES;
        }
        function getEffectivePaymentMethods() {
            return userPaymentMethods.length > 0 ? userPaymentMethods : DEFAULT_PAYMENT_METHODS;
        }

        function populateSelectWithOptions(selectElement, optionsArray, selectedValue = "", addAllOption = false, allOptionText = "All") {
            selectElement.innerHTML = ''; 
            if (addAllOption) {
                const allOpt = document.createElement('option');
                allOpt.value = "all";
                allOpt.textContent = allOptionText;
                selectElement.appendChild(allOpt);
            }
            optionsArray.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                if (opt === selectedValue) option.selected = true;
                selectElement.appendChild(option);
            });
        }

        function showNotification(message, type = 'info', duration = 3000) {
            clearTimeout(notificationTimeout); 
            notificationToast.textContent = message;
            notificationToast.className = 'notification-toast'; 
            if (type === 'error') notificationToast.classList.add('error');
            else if (type === 'success') notificationToast.classList.add('success');
            notificationToast.classList.add('show');
            notificationTimeout = setTimeout(() => notificationToast.classList.remove('show'), duration);
        }
        
        // --- Data Management ---
        function loadDataFromLocalStorage() {
            const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (storedData) {
                const parsedData = JSON.parse(storedData);
                expenses = (parsedData.expenses || []).map(exp => ({
                    ...exp, 
                    date: exp.date || formatDateForStorage(new Date()), 
                    isPaid: exp.isPaid === true, 
                    method: exp.method || getEffectivePaymentMethods()[0],
                    tags: exp.tags || '',
                    notes: exp.notes || ''
                }));
                incomes = (parsedData.incomes || []).map(inc => ({
                    ...inc,
                    date: inc.date || formatDateForStorage(new Date())
                }));
                userCategories = parsedData.userCategories || [];
                userPaymentMethods = parsedData.userPaymentMethods || [];

                nextExpenseId = parsedData.nextExpenseId || (expenses.length > 0 ? Math.max(...expenses.map(e => e.id)) + 1 : 1);
                nextIncomeId = parsedData.nextIncomeId || (incomes.length > 0 ? Math.max(...incomes.map(i => i.id)) + 1 : 1);
            } else { 
                // Default data if nothing in local storage
                const today = formatDateForStorage(new Date());
                expenses = [
                    { id: 1, date: today, expense: "Lunch", category: "Food", method: "Cash", amount: "65.00 DH", isPaid: true, tags: "client, projectA", notes: "Met with ACME Corp client" },
                    { id: 2, date: today, expense: "Groceries", category: "Food", method: "Credit Card", amount: "350.75 DH", isPaid: true, tags: "home", notes: "" },
                ];
                incomes = [
                    { id: 1, date: today, source: "Salary - April", amount: "12000.00 DH" }
                ];
                nextExpenseId = 3; 
                nextIncomeId = 2;
                saveDataToLocalStorage(); 
            }
        }

        function saveDataToLocalStorage() {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify({ 
                expenses: expenses, 
                incomes: incomes,
                userCategories: userCategories,
                userPaymentMethods: userPaymentMethods,
                nextExpenseId: nextExpenseId,
                nextIncomeId: nextIncomeId
            }));
        }

        // --- View Management ---
        function switchView(viewName) {
            currentView = viewName;
            // Hide all views
            dashboardView.style.display = 'none';
            allExpensesView.style.display = 'none';
            incomeView.style.display = 'none';
            settingsView.style.display = 'none';
            // Reset active nav links
            [navDashboard, navAllExpenses, navIncome, navSettings].forEach(nav => nav.classList.remove('active'));

            let activeNav = null;
            let headerTitle = '';

            if (viewName === 'dashboard') {
                dashboardView.style.display = 'block';
                activeNav = navDashboard;
                headerTitle = 'Dashboard';
                updateDashboardData();
            } else if (viewName === 'all-expenses') {
                allExpensesView.style.display = 'block';
                activeNav = navAllExpenses;
                headerTitle = 'All Expenses';
                renderExpenseTable(); 
                updateExpenseChart(getFilteredExpenses());
            } else if (viewName === 'income') {
                incomeView.style.display = 'block';
                activeNav = navIncome;
                headerTitle = 'Income';
                renderIncomeTable();
            } else if (viewName === 'settings') {
                settingsView.style.display = 'block';
                activeNav = navSettings;
                headerTitle = 'Settings';
                renderSettingsLists();
            }

            if (activeNav) activeNav.classList.add('active');
            mobileHeaderTitle.textContent = headerTitle;
            
            if (window.innerWidth < 768) { 
                 sidebar.classList.add('-translate-x-full');
                 sidebar.classList.remove('translate-x-0');
            }
        }
        
        // --- UI Rendering & Updates (Expenses) ---
        function createExpenseTableEntry(expenseData, isNew = false) {
            const dataRow = document.createElement('tr');
            // ... (rest of the function is similar to previous version, ensure padding is py-4 px-4 sm:px-6)
            dataRow.className = 'data-row border-b border-slate-200 hover:bg-slate-100/70 focus-within:bg-slate-100/70 transition-colors duration-150 ease-custom';
            if (isNew) dataRow.classList.add('row-adding'); 
            dataRow.dataset.id = expenseData.id;
            
            dataRow.dataset.originalDate = expenseData.date;
            dataRow.dataset.originalExpense = expenseData.expense;
            dataRow.dataset.originalCategory = expenseData.category;
            dataRow.dataset.originalMethod = expenseData.method;
            dataRow.dataset.originalAmount = expenseData.amount;
            dataRow.dataset.originalIsPaid = expenseData.isPaid;
            dataRow.dataset.originalTags = expenseData.tags;
            dataRow.dataset.originalNotes = expenseData.notes;


            const statusText = expenseData.isPaid ? 'Paid' : 'Unpaid';
            const statusDotClass = expenseData.isPaid ? 'paid' : 'unpaid';
            const statusTextClass = expenseData.isPaid ? 'paid' : 'unpaid';
            
            const cellBaseClass = "py-4 px-4 sm:px-6 text-sm";

            dataRow.innerHTML = `
                <td class="${cellBaseClass} text-slate-600 text-value-date" data-label="Date">${formatDateForDisplay(expenseData.date)}</td>
                <td class="${cellBaseClass} text-slate-700 text-value-expense" data-label="Expense">${expenseData.expense}</td>
                <td class="${cellBaseClass} text-slate-600 text-value-category" data-label="Category">${expenseData.category}</td>
                <td class="${cellBaseClass} text-slate-600 text-value-method" data-label="Method">${expenseData.method}</td>
                <td class="${cellBaseClass} text-slate-600 text-value-amount" data-label="Amount">${expenseData.amount}</td>
                <td class="${cellBaseClass} text-value-status" data-label="Status">
                    <div class="status-switch-container">
                        <span class="status-dot ${statusDotClass} hidden sm:inline-block"></span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" value="" class="sr-only peer status-checkbox-toggle" ${expenseData.isPaid ? 'checked' : ''} aria-label="Toggle paid status">
                            <div class="w-9 h-5 bg-slate-200 rounded-full peer 
                                        peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-offset-1 peer-focus:ring-cyan-400 
                                        peer-checked:bg-cyan-500 
                                        after:content-[''] after:absolute after:top-[2px] after:start-[2px] 
                                        after:bg-white after:border-slate-300 after:border after:rounded-full 
                                        after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-full">
                            </div>
                        </label>
                        <span class="status-text-indicator ${statusTextClass} ml-2.5">${statusText}</span>
                    </div>
                </td>
                <td class="${cellBaseClass} text-center" data-label="Actions">
                    <div class="action-icons flex items-center justify-center space-x-1 sm:space-x-2">
                        <button class="edit-btn p-1.5 rounded-md text-slate-400 hover:text-cyan-600 hover:bg-cyan-50 focus:outline-none focus:ring-1 focus:ring-cyan-500 transition-all duration-150 ease-custom" title="Edit">${icons.edit}</button>
                        <button class="delete-btn p-1.5 rounded-md text-slate-400 hover:text-red-600 hover:bg-red-50 focus:outline-none focus:ring-1 focus:ring-red-500 transition-all duration-150 ease-custom" title="Delete">${icons.delete}</button>
                    </div>
                </td>
            `;
            
            const editButton = dataRow.querySelector('.edit-btn');
            const deleteButton = dataRow.querySelector('.delete-btn');
            const statusToggleCheckbox = dataRow.querySelector('.status-checkbox-toggle');

            editButton.addEventListener('click', () => openExpenseModal(expenseData.id));
            deleteButton.addEventListener('click', () => confirmItemDeletion(expenseData.id, 'expense')); 
            statusToggleCheckbox.addEventListener('change', () => toggleExpensePaidStatus(expenseData.id, dataRow, statusToggleCheckbox));
            
            expenseTableBody.appendChild(dataRow);
            if (isNew) dataRow.addEventListener('animationend', () => dataRow.classList.remove('row-adding'), { once: true });
        }

        function createRecentExpenseTableEntry(expenseData) {
            const dataRow = document.createElement('tr');
            dataRow.className = 'data-row border-b border-slate-200 hover:bg-slate-100/70 focus-within:bg-slate-100/70 transition-colors duration-150 ease-custom';
            dataRow.dataset.id = expenseData.id;
            
            const statusText = expenseData.isPaid ? 'Paid' : 'Unpaid';
            const statusDotClass = expenseData.isPaid ? 'paid' : 'unpaid';
            const statusTextClass = expenseData.isPaid ? 'paid' : 'unpaid';
            const cellBaseClass = "py-4 px-4 text-sm"; // Mobile padding is handled by @media

            dataRow.innerHTML = `
                <td class="${cellBaseClass} text-slate-600" data-label="Date">${formatDateForDisplay(expenseData.date)}</td>
                <td class="${cellBaseClass} text-slate-700" data-label="Expense">${expenseData.expense}</td>
                <td class="${cellBaseClass} text-slate-600" data-label="Amount">${expenseData.amount}</td>
                <td class="${cellBaseClass}" data-label="Status">
                    <span class="status-dot ${statusDotClass}"></span>
                    <span class="status-text-indicator ${statusTextClass}">${statusText}</span>
                </td>
            `;
            recentExpensesTableBody.appendChild(dataRow);
        }
        
        function renderExpenseTable() { 
            expenseTableBody.innerHTML = ''; 
            const filteredAndSortedExpenses = getFilteredExpenses();
            filteredAndSortedExpenses.forEach(expense => createExpenseTableEntry(expense, false)); 
            checkNoItemsMessage(filteredAndSortedExpenses, noExpensesMessage, "No expenses match your current filters.", "expenses");
        }

        function renderRecentTransactions() {
            recentExpensesTableBody.innerHTML = '';
            const sortedExpenses = [...expenses].sort((a, b) => new Date(b.date) - new Date(a.date)); 
            const recent = sortedExpenses.slice(0, 5); 
            recent.forEach(expense => createRecentExpenseTableEntry(expense));
            checkNoItemsMessage(recent, noRecentExpensesMessage, "No recent expenses found.", "expenses");
        }
        
        function openExpenseModal(id = null) { 
            currentEditingId = id;
            currentEditingType = 'expense';
            clearValidationMessages(expenseForm);
            populateSelectWithOptions(modalCategoryField, getEffectiveCategories(), getEffectiveCategories()[0]);
            populateSelectWithOptions(modalMethodField, getEffectivePaymentMethods(), getEffectivePaymentMethods()[0]);

            if (id) { 
                const expense = expenses.find(e => e.id === id);
                if (!expense) return;
                expenseModalTitle.textContent = 'Edit Expense';
                confirmExpenseModalBtn.textContent = 'Save Changes';
                expenseIdField.value = expense.id;
                if(modalDateField._flatpickr) modalDateField._flatpickr.setDate(expense.date, true);
                modalExpenseField.value = expense.expense;
                modalCategoryField.value = expense.category;
                modalMethodField.value = expense.method;
                modalAmountField.value = expense.amount.replace(/[^0-9.]/g, ""); 
                modalTagsField.value = expense.tags || "";
                modalNotesField.value = expense.notes || "";
                modalPaidField.checked = expense.isPaid;
            } else { 
                expenseModalTitle.textContent = 'Add New Expense';
                confirmExpenseModalBtn.textContent = 'Add Expense';
                expenseForm.reset(); 
                expenseIdField.value = '';
                if(modalDateField._flatpickr) modalDateField._flatpickr.setDate(new Date(), true); 
            }
            expenseModal.classList.add('active');
            modalDateField.focus();
        }

        function closeExpenseModal() {
            expenseModal.classList.remove('active');
            currentEditingId = null;
            currentEditingType = null;
        }

        expenseForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (!validateExpenseModalForm()) {
                showNotification("Please correct the errors in the form.", "error");
                return;
            }

            const expenseData = {
                date: formatDateForStorage(modalDateField._flatpickr.selectedDates[0]),
                expense: modalExpenseField.value.trim(),
                category: modalCategoryField.value,
                method: modalMethodField.value,
                amount: formatCurrency(parseAmount(modalAmountField.value.trim())),
                tags: modalTagsField.value.trim(),
                notes: modalNotesField.value.trim(),
                isPaid: modalPaidField.checked
            };

            if (currentEditingId) { 
                expenseData.id = currentEditingId;
                const index = expenses.findIndex(exp => exp.id === currentEditingId);
                if (index > -1) expenses[index] = expenseData;
                showNotification('Expense updated successfully!', 'success');
            } else { 
                expenseData.id = nextExpenseId++;
                expenses.push(expenseData);
                showNotification('New expense added successfully!', 'success');
            }
            closeExpenseModal();
            refreshAllUI();
        });
        
        function toggleExpensePaidStatus(expenseId, dataRow, checkbox) {
            const expenseIndex = expenses.findIndex(e => e.id === expenseId);
            if (expenseIndex > -1) {
                expenses[expenseIndex].isPaid = checkbox.checked; 
                dataRow.dataset.originalIsPaid = expenses[expenseIndex].isPaid; 
                
                const statusTextIndicator = dataRow.querySelector('.status-text-indicator');
                const statusDot = dataRow.querySelector('.status-dot');
                const newStatusText = expenses[expenseIndex].isPaid ? 'Paid' : 'Unpaid';
                const newStatusClass = expenses[expenseIndex].isPaid ? 'paid' : 'unpaid';
                
                statusTextIndicator.textContent = newStatusText;
                statusTextIndicator.className = `status-text-indicator ml-2.5 ${newStatusClass}`; 
                if (statusDot) statusDot.className = `status-dot ${newStatusClass} hidden sm:inline-block`;
                
                refreshAllUI(); 
            }
        }
        
        function validateExpenseModalForm() { 
            let isValid = true;
            clearValidationMessages(expenseForm); 

            if (!modalDateField.value.trim() || !modalDateField._flatpickr || !modalDateField._flatpickr.selectedDates.length) { 
                setValidationError(modalDateField, modalDateValidationMsg, "Date is required.");
                isValid = false;
            } else setValidationSuccess(modalDateField, modalDateValidationMsg);

            if (!modalExpenseField.value.trim()) {
                setValidationError(modalExpenseField, modalExpenseValidationMsg, "Expense description is required.");
                isValid = false;
            } else setValidationSuccess(modalExpenseField, modalExpenseValidationMsg);

            if (!modalCategoryField.value) { 
                setValidationError(modalCategoryField, modalCategoryValidationMsg, "Category is required.");
                isValid = false;
            } else setValidationSuccess(modalCategoryField, modalCategoryValidationMsg);

            if (!modalMethodField.value) {
                setValidationError(modalMethodField, modalMethodValidationMsg, "Payment method is required.");
                isValid = false;
            } else setValidationSuccess(modalMethodField, modalMethodValidationMsg);

            const numericAmount = parseAmount(modalAmountField.value.trim());
            if (isNaN(numericAmount) || numericAmount <= 0) {
                setValidationError(modalAmountField, modalAmountValidationMsg, "Please enter a valid positive amount.");
                isValid = false;
            } else setValidationSuccess(modalAmountField, modalAmountValidationMsg);
            
            return isValid;
        }

        // --- UI Rendering & Updates (Income) ---
        function createIncomeTableEntry(incomeData, isNew = false) {
            const dataRow = document.createElement('tr');
            dataRow.className = 'data-row border-b border-slate-200 hover:bg-slate-100/70 focus-within:bg-slate-100/70 transition-colors duration-150 ease-custom';
            if (isNew) dataRow.classList.add('row-adding');
            dataRow.dataset.id = incomeData.id;

            const cellBaseClass = "py-4 px-4 sm:px-6 text-sm";
            dataRow.innerHTML = `
                <td class="${cellBaseClass} text-slate-600" data-label="Date">${formatDateForDisplay(incomeData.date)}</td>
                <td class="${cellBaseClass} text-slate-700" data-label="Source">${incomeData.source}</td>
                <td class="${cellBaseClass} text-slate-600" data-label="Amount">${formatCurrency(parseAmount(incomeData.amount))}</td>
                <td class="${cellBaseClass} text-center" data-label="Actions">
                    <div class="action-icons flex items-center justify-center space-x-1 sm:space-x-2">
                        <button class="edit-btn p-1.5 rounded-md text-slate-400 hover:text-cyan-600 hover:bg-cyan-50 focus:outline-none focus:ring-1 focus:ring-cyan-500" title="Edit">${icons.edit}</button>
                        <button class="delete-btn p-1.5 rounded-md text-slate-400 hover:text-red-600 hover:bg-red-50 focus:outline-none focus:ring-1 focus:ring-red-500" title="Delete">${icons.delete}</button>
                    </div>
                </td>
            `;
            incomeTableBody.appendChild(dataRow);

            dataRow.querySelector('.edit-btn').addEventListener('click', () => openIncomeModal(incomeData.id));
            dataRow.querySelector('.delete-btn').addEventListener('click', () => confirmItemDeletion(incomeData.id, 'income'));
            if (isNew) dataRow.addEventListener('animationend', () => dataRow.classList.remove('row-adding'), { once: true });
        }

        function renderIncomeTable() {
            incomeTableBody.innerHTML = '';
            const sortedIncomes = [...incomes].sort((a,b) => new Date(b.date) - new Date(a.date));
            sortedIncomes.forEach(income => createIncomeTableEntry(income));
            checkNoItemsMessage(sortedIncomes, noIncomeMessage, "No income recorded yet.", "income");
        }
        
        function openIncomeModal(id = null) {
            currentEditingId = id;
            currentEditingType = 'income';
            clearValidationMessages(incomeForm);
            if (id) {
                const income = incomes.find(i => i.id === id);
                if (!income) return;
                incomeModalTitle.textContent = 'Edit Income';
                confirmIncomeModalBtn.textContent = 'Save Changes';
                incomeIdField.value = income.id;
                if(modalIncomeDateField._flatpickr) modalIncomeDateField._flatpickr.setDate(income.date, true);
                modalIncomeSourceField.value = income.source;
                modalIncomeAmountField.value = parseAmount(income.amount);
            } else {
                incomeModalTitle.textContent = 'Add New Income';
                confirmIncomeModalBtn.textContent = 'Add Income';
                incomeForm.reset();
                incomeIdField.value = '';
                if(modalIncomeDateField._flatpickr) modalIncomeDateField._flatpickr.setDate(new Date(), true);
            }
            incomeModal.classList.add('active');
            modalIncomeDateField.focus();
        }

        function closeIncomeModal() {
            incomeModal.classList.remove('active');
            currentEditingId = null;
            currentEditingType = null;
        }

        incomeForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (!validateIncomeModalForm()) {
                showNotification("Please correct the errors in the income form.", "error");
                return;
            }
            const incomeData = {
                date: formatDateForStorage(modalIncomeDateField._flatpickr.selectedDates[0]),
                source: modalIncomeSourceField.value.trim(),
                amount: formatCurrency(parseAmount(modalIncomeAmountField.value.trim())),
            };

            if (currentEditingId) {
                incomeData.id = currentEditingId;
                const index = incomes.findIndex(inc => inc.id === currentEditingId);
                if (index > -1) incomes[index] = incomeData;
                showNotification('Income updated successfully!', 'success');
            } else {
                incomeData.id = nextIncomeId++;
                incomes.push(incomeData);
                showNotification('New income added successfully!', 'success');
            }
            closeIncomeModal();
            refreshAllUI();
        });

        function validateIncomeModalForm() {
            let isValid = true;
            clearValidationMessages(incomeForm);

            if (!modalIncomeDateField.value.trim() || !modalIncomeDateField._flatpickr || !modalIncomeDateField._flatpickr.selectedDates.length) {
                setValidationError(modalIncomeDateField, modalIncomeDateValidationMsg, "Date is required.");
                isValid = false;
            } else setValidationSuccess(modalIncomeDateField, modalIncomeDateValidationMsg);

            if (!modalIncomeSourceField.value.trim()) {
                setValidationError(modalIncomeSourceField, modalIncomeSourceValidationMsg, "Source is required.");
                isValid = false;
            } else setValidationSuccess(modalIncomeSourceField, modalIncomeSourceValidationMsg);
            
            const numericAmount = parseAmount(modalIncomeAmountField.value.trim());
            if (isNaN(numericAmount) || numericAmount <= 0) {
                setValidationError(modalIncomeAmountField, modalIncomeAmountValidationMsg, "Please enter a valid positive amount.");
                isValid = false;
            } else setValidationSuccess(modalIncomeAmountField, modalIncomeAmountValidationMsg);
            
            return isValid;
        }


        // --- Settings Page Logic (Categories & Payment Methods) ---
        function renderSettingsList(items, container, type, noItemsMessageElement) {
            container.innerHTML = '';
            const effectiveList = (type === 'category' ? getEffectiveCategories() : getEffectivePaymentMethods());
            const isCustomList = (type === 'category' ? userCategories.length > 0 : userPaymentMethods.length > 0);

            effectiveList.forEach(item => {
                const div = document.createElement('div');
                div.className = 'list-item-management';
                div.innerHTML = `
                    <span>${item}</span>
                    ${isCustomList || (type === 'category' ? DEFAULT_CATEGORIES.includes(item) : DEFAULT_PAYMENT_METHODS.includes(item)) ? 
                        ( (type === 'category' ? userCategories.includes(item) : userPaymentMethods.includes(item)) || (!DEFAULT_CATEGORIES.includes(item) && !DEFAULT_PAYMENT_METHODS.includes(item)) // Show delete for user-added or truly custom
                        ? `<button data-name="${item}" class="delete-${type}-btn text-red-500 hover:text-red-700 text-xs font-medium">Delete</button>` 
                        : '<span class="text-xs text-slate-400">Default</span>' )
                        : '<span class="text-xs text-slate-400">Default</span>'
                    }
                `;
                container.appendChild(div);
            });

            container.querySelectorAll(`.delete-${type}-btn`).forEach(button => {
                button.addEventListener('click', (e) => {
                    const itemName = e.target.dataset.name;
                    confirmItemDeletion(itemName, type);
                });
            });
            
            if (noItemsMessageElement) {
                 noItemsMessageElement.style.display = isCustomList ? 'none' : 'block';
            }
        }

        function renderSettingsLists() {
            renderSettingsList(userCategories, categoriesListContainer, 'category', noCustomCategoriesMessage);
            renderSettingsList(userPaymentMethods, paymentMethodsListContainer, 'paymentMethod', noCustomPaymentMethodsMessage);
        }

        addCategoryForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const newName = newCategoryNameInput.value.trim();
            if (newName && !getEffectiveCategories().map(c => c.toLowerCase()).includes(newName.toLowerCase())) {
                userCategories.push(newName);
                newCategoryNameInput.value = '';
                refreshAllUI(); // Will re-render settings and save
                showNotification(`Category "${newName}" added.`, 'success');
            } else if (newName) {
                 showNotification(`Category "${newName}" already exists.`, 'error');
            }
        });

        addPaymentMethodForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const newName = newPaymentMethodNameInput.value.trim();
            if (newName && !getEffectivePaymentMethods().map(m => m.toLowerCase()).includes(newName.toLowerCase())) {
                userPaymentMethods.push(newName);
                newPaymentMethodNameInput.value = '';
                refreshAllUI(); // Will re-render settings and save
                showNotification(`Payment method "${newName}" added.`, 'success');
            } else if (newName) {
                showNotification(`Method "${newName}" already exists.`, 'error');
            }
        });
        
        // --- Deletion Logic (Unified) ---
        function confirmItemDeletion(idOrName, type) { // id for expense/income, name for category/method
            itemToDelete = { id: idOrName, type: type };
            let message = `Are you sure you want to delete this ${type}? This action cannot be undone.`;
            if (type === 'category' || type === 'paymentMethod') {
                 // Check if category/method is in use
                const isInUse = expenses.some(exp => (type === 'category' && exp.category === idOrName) || (type === 'paymentMethod' && exp.method === idOrName));
                if (isInUse) {
                    message += `\n\nWarning: This ${type} is currently used by one or more expenses. Deleting it will remove it from the list, but existing expenses will retain this value.`;
                }
            }
            deleteModalMessage.textContent = message;
            deleteModalTitle.textContent = `Delete ${type.charAt(0).toUpperCase() + type.slice(1)}`;
            deleteConfirmModal.classList.add('active');
            confirmDeleteBtn.focus(); 
        }

        function closeDeleteModal() {
            deleteConfirmModal.classList.remove('active');
            itemToDelete = { id: null, type: null };
        }

        function executeDelete() {
            if (!itemToDelete.type) return;

            let itemNameForNotification = String(itemToDelete.id); // Default to ID

            if (itemToDelete.type === 'expense') {
                expenses = expenses.filter(e => e.id !== itemToDelete.id); 
            } else if (itemToDelete.type === 'income') {
                incomes = incomes.filter(i => i.id !== itemToDelete.id);
            } else if (itemToDelete.type === 'category') {
                userCategories = userCategories.filter(cat => cat !== itemToDelete.id); // id here is the name
                itemNameForNotification = itemToDelete.id;
            } else if (itemToDelete.type === 'paymentMethod') {
                userPaymentMethods = userPaymentMethods.filter(pm => pm !== itemToDelete.id); // id here is the name
                itemNameForNotification = itemToDelete.id;
            }
            
            refreshAllUI(); 
            showNotification(`${itemToDelete.type.charAt(0).toUpperCase() + itemToDelete.type.slice(1)} "${itemNameForNotification}" deleted successfully.`, 'success');
            closeDeleteModal();
        }

        // --- Validation (Shared) ---
        function setValidationError(field, messageElement, message) {
            field.classList.add('invalid');
            field.classList.remove('valid');
            if (messageElement) messageElement.textContent = message;
        }

        function setValidationSuccess(field, messageElement) {
            field.classList.add('valid');
            field.classList.remove('invalid');
            if (messageElement) messageElement.textContent = ''; 
        }

        function clearValidationMessages(formContainer) {
            formContainer.querySelectorAll('.form-input.invalid, .form-select.invalid, .form-date-input.invalid, .form-textarea.invalid').forEach(f => f.classList.remove('invalid'));
            formContainer.querySelectorAll('.form-input.valid, .form-select.valid, .form-date-input.valid, .form-textarea.valid').forEach(f => f.classList.remove('valid'));
            formContainer.querySelectorAll('.validation-message').forEach(el => el.textContent = '');
        }

        // --- Filtering and Sorting (Expenses) ---
        function getFilteredExpenses() { // Renamed from getFilteredAndSortedExpenses for clarity
            let filtered = [...expenses]; 
            const dateRange = filterDateRangeSelect.value;
            const now = new Date();
            
            if (dateRange !== 'all') {
                let startDate, endDate;
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                
                if (dateRange === 'this-month') {
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
                } else if (dateRange === 'last-month') {
                    startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    endDate = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59, 999);
                } else if (dateRange === 'this-year') {
                    startDate = new Date(now.getFullYear(), 0, 1);
                    endDate = new Date(now.getFullYear(), 11, 31, 23, 59, 59, 999);
                }
                
                if (startDate && endDate) {
                     filtered = filtered.filter(exp => {
                        const expDate = new Date(exp.date);
                        const expDateNormalized = new Date(expDate.getFullYear(), expDate.getMonth(), expDate.getDate());
                        return expDateNormalized >= startDate && expDateNormalized <= endDate;
                    });
                }
            }
            
            const statusFilter = filterStatusSelect.value;
            if (statusFilter !== 'all') {
                filtered = filtered.filter(exp => String(exp.isPaid) === (statusFilter === 'paid' ? 'true' : 'false'));
            }

            const categoryFilter = filterCategorySidebarSelect.value;
            if (categoryFilter !== 'all') {
                filtered = filtered.filter(exp => exp.category === categoryFilter);
            }

            filtered.sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                return currentSortOrder === 'asc' ? dateA - dateB : dateB - dateA;
            });
            return filtered;
        }

        // --- Summaries and Charts ---
        function updateSidebarTotals(filteredExp) { 
            let totalIncomeAllTime = incomes.reduce((sum, inc) => sum + parseAmount(inc.amount), 0);
            let totalPaid = 0;
            let totalUnpaid = 0;
            filteredExp.forEach(exp => {
                const amount = parseAmount(exp.amount);
                if (exp.isPaid) totalPaid += amount;
                else totalUnpaid += amount;
            });
            const totalExpensesFiltered = totalPaid + totalUnpaid;
            const netTotal = totalIncomeAllTime - expenses.reduce((sum, exp) => sum + parseAmount(exp.amount), 0); // Net based on ALL expenses, not just filtered

            sidebarTotalIncomeEl.textContent = formatCurrency(totalIncomeAllTime);
            sidebarTotalPaidEl.textContent = formatCurrency(totalPaid);
            sidebarTotalUnpaidEl.textContent = formatCurrency(totalUnpaid);
            sidebarGrandTotalEl.textContent = formatCurrency(netTotal);
        }
        
        function updateDashboardData() {
            const now = new Date();
            const currentMonthExpenses = expenses.filter(exp => {
                const expDate = new Date(exp.date);
                return expDate.getFullYear() === now.getFullYear() && expDate.getMonth() === now.getMonth();
            });
            const currentMonthIncomes = incomes.filter(inc => {
                const incDate = new Date(inc.date);
                return incDate.getFullYear() === now.getFullYear() && incDate.getMonth() === now.getMonth();
            });

            let totalSpentMonth = 0;
            let totalPaidMonth = 0;
            let totalUnpaidMonth = 0;
            currentMonthExpenses.forEach(exp => {
                const amount = parseAmount(exp.amount);
                totalSpentMonth += amount;
                if (exp.isPaid) totalPaidMonth += amount; // Not used on dashboard cards, but good to have
                else totalUnpaidMonth += amount;
            });

            const totalIncomeMonth = currentMonthIncomes.reduce((sum, inc) => sum + parseAmount(inc.amount), 0);
            const netSavingsMonth = totalIncomeMonth - totalSpentMonth;

            dashboardTotalIncomeMonthEl.textContent = formatCurrency(totalIncomeMonth);
            dashboardTotalSpentMonthEl.textContent = formatCurrency(totalSpentMonth);
            dashboardNetSavingsMonthEl.textContent = formatCurrency(netSavingsMonth);
            dashboardTotalUnpaidMonthEl.textContent = formatCurrency(totalUnpaidMonth);
            
            renderRecentTransactions();
            updateDashboardChart(currentMonthExpenses);
        }

        function updateChart(chartInstance, chartEl, dataForChart, noDataMessageEl, chartTitle = 'Expenses by Category') {
            if (chartInstance) { 
                chartInstance.destroy();
            }
            if (!dataForChart || dataForChart.length === 0) { 
                chartEl.style.display = 'none';
                noDataMessageEl.style.display = 'flex'; 
                return null; 
            }
            const categoryTotals = dataForChart.reduce((acc, expense) => {
                const category = expense.category || 'Uncategorized'; 
                const amount = parseAmount(expense.amount);
                acc[category] = (acc[category] || 0) + amount;
                return acc;
            }, {});
            const labels = Object.keys(categoryTotals);
            const data = Object.values(categoryTotals);

            if (labels.length === 0) { 
                 chartEl.style.display = 'none';
                 noDataMessageEl.style.display = 'flex';
                 return null;
            }

            chartEl.style.display = 'block';
            noDataMessageEl.style.display = 'none';
            
            const chartColors = ['#06b6d4', '#0ea5e9', '#22d3ee', '#67e8f9', '#a5f3fc', '#14b8a6', '#10b981', '#34d399', '#6ee7b7', '#a7f3d0'];

            const newChartInstance = new Chart(chartEl, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: chartTitle, data: data,
                        backgroundColor: labels.map((_, i) => chartColors[i % chartColors.length]),
                        borderColor: '#ffffff', borderWidth: 2, hoverOffset: 8, hoverBorderColor: '#e2e8f0' 
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, 
                    animation: { animateScale: true, animateRotate: true, duration: 800, easing: 'easeInOutQuart' },
                    plugins: {
                        legend: { position: 'bottom', labels: { font: { family: "'Inter', sans-serif", size: 11 }, color: '#475569', padding: 15, usePointStyle: true, pointStyle: 'circle' }},
                        tooltip: {
                            backgroundColor: '#0f172a', titleFont: { family: "'Inter', sans-serif", size: 13, weight: '600' }, 
                            bodyFont: { family: "'Inter', sans-serif", size: 11 }, padding: 10, cornerRadius: 6, displayColors: true, boxPadding: 4, 
                            callbacks: { 
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed !== null) {
                                        label += formatCurrency(context.parsed); 
                                        const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                                        const percentage = total > 0 ? (context.parsed / total * 100).toFixed(1) : 0;
                                        label += ` (${percentage}%)`;
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    cutout: '60%',
                    onClick: (event, elements) => { 
                        if (elements.length > 0) {
                            const chartElement = elements[0];
                            const clickedCategory = labels[chartElement.index];
                            filterCategorySidebarSelect.value = clickedCategory; 
                            switchView('all-expenses'); 
                            refreshAllUI(); 
                        }
                    }
                }
            });
            return newChartInstance;
        }
        
        function updateExpenseChart(dataForChart) {
            expenseChartInstance = updateChart(expenseChartInstance, expenseChartEl, dataForChart, noChartDataMessage, 'Filtered Expense Distribution');
        }
        function updateDashboardChart(dataForChart) {
            dashboardChartInstance = updateChart(dashboardChartInstance, dashboardExpenseChartEl, dataForChart, noDashboardChartDataMessage, 'This Month\'s Expenses');
        }

        function checkNoItemsMessage(currentDisplayData, messageElement, specificMessage, itemType = "items") { 
            const hasDataToDisplay = currentDisplayData && currentDisplayData.length > 0;
            const totalItems = itemType === "expenses" ? expenses.length : incomes.length;

            if (totalItems === 0) { 
                messageElement.querySelector('p').textContent = `No ${itemType} yet.`;
                messageElement.querySelector('span').textContent = `Click "Add ${itemType.charAt(0).toUpperCase() + itemType.slice(1, -1)}" in the sidebar to get started!`;
                messageElement.style.display = 'flex'; 
            } else if (!hasDataToDisplay) { 
                messageElement.querySelector('p').textContent = specificMessage;
                messageElement.querySelector('span').textContent = 'Try adjusting filters or adding new items.';
                messageElement.style.display = 'flex';
            } else {
                messageElement.style.display = 'none';
            }
        }

        // --- Main Refresh Function ---
        function refreshAllUI() {
            saveDataToLocalStorage(); 
            const filteredExp = getFilteredExpenses(); // Only expenses are filtered by sidebar filters for now
            
            // Update select dropdowns with current categories/methods
            populateSelectWithOptions(modalCategoryField, getEffectiveCategories(), modalCategoryField.value || getEffectiveCategories()[0]);
            populateSelectWithOptions(modalMethodField, getEffectivePaymentMethods(), modalMethodField.value || getEffectivePaymentMethods()[0]);
            populateSelectWithOptions(filterCategorySidebarSelect, getEffectiveCategories(), filterCategorySidebarSelect.value || "all", true, "All Categories");


            if (currentView === 'dashboard') {
                updateDashboardData(); 
            } else if (currentView === 'all-expenses') {
                renderExpenseTable(); 
                updateExpenseChart(filteredExp);         
            } else if (currentView === 'income') {
                renderIncomeTable();
            } else if (currentView === 'settings') {
                renderSettingsLists();
            }
            updateSidebarTotals(filteredExp); 
        }

        // --- Event Listeners ---
        showAddExpenseModalBtn.addEventListener('click', () => openExpenseModal());
        closeExpenseModalBtn.addEventListener('click', closeExpenseModal);
        cancelExpenseModalBtn.addEventListener('click', closeExpenseModal);
        expenseModal.addEventListener('click', (event) => { 
            if (event.target === expenseModal) closeExpenseModal();
        });

        showAddIncomeModalBtn.addEventListener('click', () => openIncomeModal());
        closeIncomeModalBtn.addEventListener('click', closeIncomeModal);
        cancelIncomeModalBtn.addEventListener('click', closeIncomeModal);
        incomeModal.addEventListener('click', (event) => {
            if (event.target === incomeModal) closeIncomeModal();
        });

        cancelDeleteBtn.addEventListener('click', closeDeleteModal);
        confirmDeleteBtn.addEventListener('click', executeDelete);
        deleteConfirmModal.addEventListener('click', (event) => { 
            if (event.target === deleteConfirmModal) closeDeleteModal();
        });
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                if (expenseModal.classList.contains('active')) closeExpenseModal();
                if (incomeModal.classList.contains('active')) closeIncomeModal();
                if (deleteConfirmModal.classList.contains('active')) closeDeleteModal();
            }
        });

        // Navigation
        navDashboard.addEventListener('click', (e) => { e.preventDefault(); switchView('dashboard'); });
        navAllExpenses.addEventListener('click', (e) => { e.preventDefault(); switchView('all-expenses'); });
        navIncome.addEventListener('click', (e) => { e.preventDefault(); switchView('income'); });
        navSettings.addEventListener('click', (e) => { e.preventDefault(); switchView('settings'); });


        sidebarToggleMobile.addEventListener('click', () => {
            sidebar.classList.toggle('-translate-x-full'); 
            sidebar.classList.toggle('translate-x-0');
        });
        document.addEventListener('click', (event) => {
            if (window.innerWidth < 768) { 
                const isClickInsideSidebar = sidebar.contains(event.target);
                const isClickOnToggler = sidebarToggleMobile.contains(event.target);
                if (!isClickInsideSidebar && !isClickOnToggler && sidebar.classList.contains('translate-x-0')) {
                    sidebar.classList.add('-translate-x-full');
                    sidebar.classList.remove('translate-x-0');
                }
            }
        });

        filterDateRangeSelect.addEventListener('change', refreshAllUI);
        filterStatusSelect.addEventListener('change', refreshAllUI);
        filterCategorySidebarSelect.addEventListener('change', refreshAllUI);
        sortDateBtn.addEventListener('click', () => {
            currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
            sortIconAsc.classList.toggle('hidden', currentSortOrder === 'desc');
            sortIconDesc.classList.toggle('hidden', currentSortOrder === 'asc');
            if (currentView === 'all-expenses') refreshAllUI(); 
        });

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            flatpickr(modalDateField, { dateFormat: "Y-m-d", defaultDate: "today", altInput: true, altFormat: "M j, Y" });
            flatpickr(modalIncomeDateField, { dateFormat: "Y-m-d", defaultDate: "today", altInput: true, altFormat: "M j, Y" });
            
            loadDataFromLocalStorage(); 
            switchView('dashboard'); 
            // refreshAllUI will be called by switchView's specific update functions
        });
    </script>
</body>
</html>
